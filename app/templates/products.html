{% extends "base.html" %}

{% block head %}
    {{ super() }}
    <!-- 4. bootstrap1-select组件引用 -->
    <script src="../static/bootstrap-select/dist/js/bootstrap-select.js"></script>
    <link href="../static/bootstrap-select/dist/css/bootstrap-select.css" rel="stylesheet" />
    <script src="../static/bootstrap-select/dist/js/i18n/defaults-zh_CN.js"></script>

{% endblock %}

{% block page_content %}
    <select id="type_select" class="selectpicker show-tick" data-live-search="true" title="请选择产品类别">
    </select>
    <div id="toolbar">
        <button id="remove_button" class="btn btn-danger" disabled>
            <i class="glyphicon glyphicon-remove"></i> 删除
        </button>
        <button id="add_button" class="btn btn-info">
            <i class="glyphicon glyphicon-plus"></i> 添加
        </button>
        <button id="save_button" class="btn btn-success">
            <i class="glyphicon glyphicon-save"></i> 保存
        </button>
    </div>
    <table id="table"  
            data-toggle="table"
            data-toolbar="#toolbar"
            data-search="true"
            data-show-columns="true"
            data-show-export="true"
            data-unique-id="id"
            >  
    </table>

    <script>
        'use strict'
        var $table = $('#table');
        $table.bootstrapTable({
            columns:[{
                "checkbox": true
            },{
                "field": 'product_id',
                "title": '产品ID',
                "sortable": true
            },{
                "field": 'product_name',
                "title": '产品名称',
                "sortable": true,
                "editable": {
                    "mode": "inline",
                    "type": 'text',
                    "validate": function (v) {
                        if (!v) return '不能为空';  
                    }
                }
            },{
                "field": 'single_original_price',
                "title": '原价(单)/欧元',
                "sortable": true,
                "editable": {
                    "mode": "inline",
                    "type": 'text',
                    "validate": function (v) {
                        if (!v) return '不能为空';  
                    }
                }
            },{
                "field": 'discount',
                "title": '折扣',
                "sortable": true,
                "editable": {
                    "mode": "inline",
                    "type": 'text',
                    "validate": function (v) {
                        if (!v) return '不能为空';  
                    }
                }
            },{
                "field": 'type',
                "title": '产品种类',
                "editable": {
                    "mode": "inline",
                    "type": 'text',
                    "validate": function (v) {
                        if (!v) return '不能为空';  
                    }
                }
            }]
            /*
            onEditableSave: function (field, row, oldValue, $el){
                if (["single_original_price", "discount", "product_count"].indexOf(field) != -1){
                    console.log("call onEdit");
                    let discount = parseFloat(row.discount);
                    let single_original_price = parseFloat(row.single_original_price);
                    let product_count = parseInt(row.product_count);
                    let row_index = parseInt(row.product_id);
                    console.log("row_index: " + row_index);
                    let $total_buy_price = $table.find("tr").eq(row_index).find("a[data-name=total_buy_price]");                    
                    if (row.discount > 1){
                        alert("你确定折扣大于1么，傻妞？");
                    } else if (row.discount > 0){
                        $total_buy_price.text(single_original_price*discount*product_count);
                    } else if (row.discount < 0){
                        $total_buy_price.text((single_original_price - discount)*product_count);
                    }
                }
            }
            */
        });

        /* 种类选择 */
        var $type = $("#type_select");
        var type_name = $type.val();
        $.ajax({
            url:"/get_product_list",
            data:"",
            type:"POST",
            dataType:"json",
            success:function(data){
                console.log(data);
            }
        });

        console.log("默认种类: " + type_name);
        $type.on("changed.bs.select", function(event, clickedIndex, newValue, oldValue){
            batch_name = $type.val();
            alert("选择种类：" + type_name);
            $.ajax({
                url:"/get_product_list",
                data:type_name,
                type:"POST",
                dataType:"json",
                success:function(data){
                    console.log(data)
                    $table.bootstrapTable("load", data);
                }
            })
        });

        /* 添加数据 */
        function get_default_data(old_id){
            var default_data = [{
                "product_id": 0,
                "product_name": "",
                "single_original_price": "1",
                "discount": "0.9",
                "product_count": 1,
                "single_buy_price": "1",
                "total_buy_price": "0.9",
                "type": "杂货"
            }];
            var new_id = old_id + 1;
            console.log(new_id);
            default_data[0]["product_id"] = new_id;
            return default_data;
        }

        var $add_button = $("#add_button");
        $add_button.click(function() {
            var td = $table.find("tr").last().find("td").eq(1);
            var old_id;
            if (td.length == 0){
                old_id = 0;
            } else {
                old_id = td.text();
            }
            console.log("old_id: "+old_id);
            $table.bootstrapTable('append', get_default_data(parseInt(old_id)));
            $table.bootstrapTable('scrollTo', 'bottom');
        });

        //todo: 产品填加

        /* 总价根据原价，折扣，数量变化 */
    </script>
{% endblock %}