<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width" />
    <title>BootStrap Table使用</title>
    <!--@*1、Jquery组件引用*@-->
    <script src="../static/jquery-1.9.1.js"></script>

    <!--@*2、bootstrap组件引用*@-->
    <script src="../static/bootstrap-3.3.7/dist/js/bootstrap.js"></script>
    <link href="../static/bootstrap-3.3.7/dist/css/bootstrap.css" rel="stylesheet" />

    <!--@*3、bootstrap table组件以及中文包的引用*@-->
    <script src="../static/bootstrap-table/dist/bootstrap-table.js"></script>
    <link href="../static/bootstrap-table/dist/bootstrap-table.css" rel="stylesheet" />
    <script src="../static/bootstrap-table/dist/locale/bootstrap-table-zh-CN.js"></script>


    <script src="../static/x-editable/dist/bootstrap3-editable/js/bootstrap-editable.js"></script>
    <link href="../static/x-editable/dist/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet" />

    <script src="../static/bootstrap-table/dist/extensions/editable/bootstrap-table-editable.js"></script>
	<script src="../static/bootstrap-table/dist/locale/bootstrap-table-zh-CN.js"></script>
    
    <!-- 4. bootstrap1-select组件引用 -->
    <script src="../static/bootstrap-select/dist/js/bootstrap-select.js"></script>
    <link href="../static/bootstrap-select/dist/css/bootstrap-select.css" rel="stylesheet" />
    <script src="../static/bootstrap-select/dist/js/i18n/defaults-zh_CN.js"></script>

</head>
<body>

<div class="container">
    <h1></h1>
    <select id="batch_select" class="selectpicker show-tick" data-live-search="true" title="请选择批次">
        <option value="第1批">第1批</option>
        <option value="第2批">第2批</option>
    </select>
	<div id="toolbar">
		<button id="remove_button" class="btn btn-danger" disabled>
			<i class="glyphicon glyphicon-remove"></i> 删除
		</button>
		<button id="add_button" class="btn btn-info">
			<i class="glyphicon glyphicon-plus"></i> 添加
        </button>
        <button id="save_button" class="btn btn-success">
			<i class="glyphicon glyphicon-save"></i> 保存
        </button>
        <button id="mode_button" class="btn btn-default">
            <i class="glyphicon glyphicon-retweet"></i> 本人模式
        </button>
    </div> 
    <div>
    <table id="table" class="text-nowrap"
            data-toggle="table"
            data-toolbar="#toolbar"
            data-search="true"
            data-show-columns="true"
            data-show-export="true"
            data-unique-id="id"
            >  
    </table>
    </div>
</div>

<script>
	'use strict';
    /* 初始化表格 */
	var $table = $('#table');
    $table.bootstrapTable({
        columns: [{
            "checkbox": true
        },{
            "field": 'product_id',
            "title": '产品ID',
            "sortable": true
        },{
            "field": 'product_name',
            "title": '产品名称',
            "sortable": true,
            "editable": {
                "mode": "popup",
                "type": 'select',
				"title": '选择产品',
				"source": [{ value: "爱1", text: "爱1" }, { value: "爱2", text: "爱2" }, {value:"爱3",text:"爱3"}],
                "validate": function (v) {
                    if (!v) return '不能为空';  
                }
            }
        }, {
            "field": 'product_count',
            "title": '数量',
            "sortable": true,
            "editable": {
                "mode": "inline",
                "type": 'text',
                "validate": function (v) {
                    if (!v) return '不能为空';  
                }
            }
        }, {
            "field": 'single_original_price',
            "title": '原价(单)/欧元',
            "sortable": true,
            "editable": {
                "mode": "inline",
                "type": 'text',
                "validate": function (v) {
                    if (!v) return '不能为空';  
                }
            }
        },{
            "field": 'discount',
            "title": '折扣',
            "sortable": true,
            "editable": {
                "mode": "inline",
                "type": 'text',
                "validate": function (v) {
                    if (!v) return '不能为空';  
                }
            }
        },{
            "field": 'single_buy_price',
            "title": '实价(单)/欧元',
            "sortable": true,
            "editable": {
                "mode": "inline",
                "type": 'text',
                "validate": function (v) {
                    if (!v) return '不能为空';  
                }
            }
        },{
            "field": 'total_buy_price',
            "title": '实价(总)/欧元',
            "sortable": true,
            "editable": {
                "mode": "inline",
                "type": 'text',
                "validate": function (v) {
                    if (!v) return '不能为空';  
                }
            }
        },{
            "field": 'single_sell_price',
            "title": '售价(单)/人民币',
            "sortable": true,
            "visible": false,
            "editable": {
                "mode": "inline",
                "type": 'text',
                "validate": function (v) {
                    if (!v) return '不能为空';  
                }
            }
        },{
            "field": 'total_sell_price',
            "title": '售价(总)/人民币',
            "sortable": true,
            "visible": false,
            "editable": {
                "mode": "inline",
                "type": 'text',
                "validate": function (v) {
                    if (!v) return '不能为空';  
                }
            }
        },{
            "field": 'single_profit',
            "title": '利润(单)/人民币',
            "sortable": true,
            "visible": false,
            "editable": {
                "mode": "inline",
                "type": 'text',
                "validate": function (v) {
                    if (!v) return '不能为空';  
                }
            }
        },{
            "field": 'total_profit',
            "title": '利润(总)/人民币',
            "sortable": true,
            "visible": false,
            "editable": {
                "mode": "inline",
                "type": 'text',
                "validate": function (v) {
                    if (!v) return '不能为空';  
                }
            }
        },{
            "field": "date",
            "title": "日期",
            "type": "text",
            "sortable": true,
            "editable": {
                "type": "date",
                "placement": "bottom",
                "validate": function (v) {
                    if (!v) return '不能为空';  
                }
            }
        },{
            "field": "batch_info",
            "title": "批次",
            "type": "text",
            "sortable": true,
        }],
        onEditableSave: function (field, row, oldValue, $el){
            alert(field + " " + row.discount);
        }
    });
    /*****************************************/

    /* 批次选择 */
    var $batch = $("#batch_select")
    var batch_name = $batch.val();
    console.log("默认批次: " + batch_name);
    $batch.on("changed.bs.select", function(event, clickedIndex, newValue, oldValue){
        batch_name = $batch.val();
        alert("选择批次：" + batch_name);
        $.ajax({
            url:"/getbatch",
            data:batch_name,
            type:"POST",
            dataType:"json",
            success:function(data){
                console.log(data)
                $table.bootstrapTable("load", data);
            }
        })
    });
    /*****************************************/


    /* 页面左上功能按钮*/
    /* 删除键 */
    var $remove = $("#remove_button");
    $table.on('check.bs.table uncheck.bs.table check-all.bs.table uncheck-all.bs.table', function () {
        $remove.prop('disabled', !$table.bootstrapTable('getSelections').length);
        // save your data, here just save the current page
    });
    
    $remove.click(function(){
    	var ids = getIdSelections();
    	console.log(ids)
    	$table.bootstrapTable("remove", {
    		field: "product_id",
    		values: ids
    	});
    	 $remove.prop('disabled', true);
    });

    /* 返回checkbox选中的列的id */
    function getIdSelections() {
        return $.map($table.bootstrapTable('getSelections'), function (row) {
            console.log(row.product_id);
        	return row.product_id
        });
    }

    /* 初始化默认添加数据 */
    /* 获得当前日期 */
    function getToday(){
    	var current_date = new Date();
        var year = current_date.getFullYear();
        var month = current_date.getMonth() + 1;
        var day = current_date.getDate();
    	if (month < 10){
    		month = "0" + month;
        }
        if (day < 10){
            day = "0" + day;
        }
    	var today =  year + "-" + month + "-" + day;
    	return today;
    }
    
    var today = getToday();
    console.log(today);
    /* 根据当前表格最下端id动态创建新id */
	function get_default_data(old_id){
		var default_data = [{
			"product_id": 0,
			"product_name": "爱1",
			"product_count": "1",
			"single_original_price": "10",
			"discount": "0.9",
			"single_buy_price": "9",
			"total_buy_price": "9",
			"single_sell_price": "145",
			"total_sell_price": "145",
			"single_profit": "73",
	        "total_profit": "73",
            "date": today,
            "batch_info": batch_name
		}];
		var new_id = old_id + 1;
		default_data[0]["product_id"] = new_id;
		return default_data;
	}
	
	var $add_button = $("#add_button");
	$add_button.click(function () {
        var td = $table.find("tr").last().find("td").eq(1);
        var old_id;
        if (td.length == 0){
            old_id = 0;
        } else {
            old_id = td.text();
        }
        $table.bootstrapTable('append', get_default_data(parseInt(old_id)));
        $table.bootstrapTable('scrollTo', 'bottom');
        console.log("**********************")
	});

    /* 提交后端保存数据 */
    var $save = $("#save_button");
    $save.click(function(){
        var table_data = $table.bootstrapTable('getData');
        var data = JSON.stringify(table_data);
        console.log(data);
        $.ajax({
            url:"/datafromtable",
            data: data,
            type:"POST",
            dataType: "text",
            success:function(data){
                alert(data);
            }
        })
    });
    /*****************************************/

    /* 切换显示模式 */
    var $mode = $("#mode_button");
    var columns_list = ["single_sell_price", "total_sell_price", "single_profit", "total_profit"]
    $mode.click(function(){
        var old_mode = $.trim($(this).text());
        var new_mode;
        var mode_operation;
        if (old_mode=="本人模式"){
            new_mode = "对帐模式";
            mode_operation = "showColumn";
        } else {
            new_mode = "本人模式";
            mode_operation = "hideColumn";
        }
        var new_html = $(this).html().replace(old_mode, new_mode);
        $(this).html(new_html);
        var columns_name;
        $.each(columns_list, function(index, value){
            $table.bootstrapTable(mode_operation, value);
        });

    });


    /* 点击标题更改货币单位并换算 */
    var $container = $("div.container")
    $container.on("click", "table th", function() {
    	var name, currency_unit;
    	[name, currency_unit] = $(this).text().split("/");
    	if (currency_unit == "欧元"){
    		var new_text = name +"/"+"人民币";
    	} else if (currency_unit == "人民币"){
    		var new_text = name +"/"+"欧元";
		} else {
			return 
		}
		$(this).find("div.th-inner").text(new_text);
		
		var index = $(this).index();
		$('#table tr').find('td').each(function() {
			if ($(this).index() == index) {
				if (currency_unit == "欧元"){
					$(this).find("a").text(parseFloat($(this).text())*8);
				} else {
					$(this).find("a").text(parseFloat($(this).text())/8);
				}
			}
		});
	});
     /*****************************************/
</script>
</body>
</html>
